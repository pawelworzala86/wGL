<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hello World Triangle Example</title>
</head>

<body style="background-color: black">
  <div style="text-align: center">
    <canvas id="cnvs" width="512" height="512"></canvas>
  </div>
</body>
<script type="module">
  //import { initASWebGLue, ASWebGLReady } from './ASWebGLue2.js';
  import {initMyFuncs} from './MyFuncs.js'



  const wasm_file = 'triangle.wasm';
  var exports;



  var w = window.innerWidth * 0.99;
  var h = window.innerHeight * 0.99;
  var cnvs = document.getElementById("cnvs");
  if (w > h) {
    cnvs.width = h;
    cnvs.height = h;
  }
  else {
    cnvs.width = w;
    cnvs.height = w;
  }



  



  /*function renderFrame() {
    // call the displayLoop function in the WASM module
    exports.displayLoop();

    // requestAnimationFrame calls renderFrame the next time a frame is rendered
    requestAnimationFrame(renderFrame);

  }*/

  const memory = new WebAssembly.Memory({ initial: 100 }); // linear memory

  var importObject = {
    env: {
      memory: memory,
      seed: Date.now,
    }
  };


  importObject.env.abort = (...args) => {
    console.log("abort");
    //console.log(WebGL.getString(args[0]));
  }

  initMyFuncs(importObject)
  //initASWebGLue(importObject);
  

  ;(async () => {
    // use WebAssembly.instantiateStreaming in combination with
    // fetch instead of WebAssembly.instantiate and fs.readFileSync
    let obj = await WebAssembly.instantiateStreaming(
      fetch(wasm_file),
      importObject);
    console.log(obj);

    //let wasmModule = obj.instance
    exports = obj.instance.exports;
    console.log(exports);










    const memory = exports.memory;

    let arr = exports.getArray();
    let len = exports.getArrayLength();
  console.log(arr)

  let wasmMemory = new Float32Array(memory.buffer, arr, 4);
  console.log(`Odczytana tablica: ${wasmMemory}`);

  wasmMemory[0] = 10.5; wasmMemory[1] = 20.5;

  wasmMemory = new Float32Array(memory.buffer, arr, 4);
  console.log(`Odczytana tablica: ${wasmMemory}`);




// Przykładowa tablica Float32Array (JavaScript)
const jsArray = new Float32Array([1.0, 2.0, 3.0]);

// Ręczna alokacja pamięci w WASM
const arrayPointer = exports.memory.grow(jsArray.length * jsArray.BYTES_PER_ELEMENT / 65536); // Alokacja nowych stron pamięci (każda strona ma 64 KB)
const wasmMemory3 = new Float32Array(exports.memory.buffer, arrayPointer, jsArray.length);

// Skopiowanie danych z Float32Array do pamięci WASM
wasmMemory3.set(jsArray);

  exports.setArray(arrayPointer, jsArray.length);


  let arr2 = exports.getArrayFromSet();
  
  let wasmMemory2 = new Float32Array(memory.buffer, arr2, 3);
  console.log(`Odczytana tablica: ${wasmMemory2}`);



    //ASWebGLReady(obj, importObject);
    //requestAnimationFrame(renderFrame);
  })();

</script>

</html>